!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=9)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.config=void 0;var r,o=(r=n(4))&&r.__esModule?r:{default:r};var i=Object.assign({globalCacheDuration:600,totalBrowsers:2},n(13)(o.default.join(process.cwd(),"./config.json")));if(t.config=i,!i)throw new Error("Cannot find `config.json` file.");i.cachedDir||(i.cachedDir=o.default.join(process.cwd(),"./.cache"))},function(e,t){e.exports=require("rxjs/internal/operators/tap")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.cacheManager=void 0;var r=a(n(11)),o=a(n(4)),i=a(n(12)),u=n(0);function a(e){return e&&e.__esModule?e:{default:e}}var c=new(function(){function e(){}return e.prototype.clear=function(){(0,i.default)(u.config.cachedDir,function(){console.log("Cleared existing cache")})},e.prototype.save=function(e,t){r.default.writeFileSync(this.getPath(e),JSON.stringify({path:e,cachedAt:Date.now(),content:t}))},e.prototype.read=function(e){if(r.default.existsSync(this.getPath(e)))return JSON.parse(r.default.readFileSync(this.getPath(e),"utf-8"))},e.prototype.getPath=function(e){return o.default.join(u.config.cachedDir,e.replace(/([\t-\r \/\xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF])/gi,"\\$1"))},e}());t.cacheManager=c},function(e,t){e.exports=require("rxjs/operators")},function(e,t){e.exports=require("path")},function(e,t,n){"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.startServer=function(){o.listen(1002,"localhost",function(){console.log("Listening on port 1002")})},t.app=void 0;var o=(0,((r=n(14))&&r.__esModule?r:{default:r}).default)();t.app=o},function(e,t){e.exports=require("rxjs")},function(e,t){e.exports=require("rxjs/internal/observable/of")},function(e,t){e.exports=require("rxjs/internal/operators/filter")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.run=function(){return(new o.Engine).start$.pipe((0,r.tap)(function(){return(0,i.startServer)()}))},n(10);var r=n(1),o=n(15),i=n(5)},function(e,t,n){"use strict";var r=n(2),o=n(5),i=function(){return(i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};o.app.get("*",function(e,t){console.log(e.path);var n=r.cacheManager.read(e.path);t.json(n?i({success:!0},n):{success:!1})})},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("rimraf")},function(e,t){function n(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}n.keys=function(){return[]},n.resolve=n,e.exports=n,n.id=13},function(e,t){e.exports=require("express")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Engine=void 0;var r=n(6),o=n(7),i=n(8),u=n(1),a=n(3),c=n(2),s=n(16),f=n(0),p=function(){function e(){var e=this;this.interval=(0,r.interval)(),this.runningLoop=!1,this.start$=new r.Observable(function(t){c.cacheManager.clear(),e.previousRunTime=Date.now();var n=e.interval.pipe((0,i.filter)(function(){return!e.runningLoop}),(0,u.tap)(function(){return e.runningLoop=!0}),(0,a.flatMap)(function(){var t=Date.now(),n=t-e.previousRunTime;return e.previousRunTime=t,e.loop(n).pipe((0,a.first)())}),(0,u.tap)(function(){return e.runningLoop=!1})).subscribe();t.add(n),t.next()}).pipe((0,a.shareReplay)(1)),this.cachedPaths=f.config.cachedPaths.map(function(e){return new s.CachedPath(e)})}return e.prototype.loop=function(e){return(0,r.combineLatest)(this.cachedPaths.map(function(t){return t.run(e)||(0,o.of)(null)}))},e}();t.Engine=p},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CachedPath=void 0;var r=n(1),o=n(3),i=n(2),u=n(0),a=n(17),c=function(){function e(e){var t=e.path,n=e.cacheDuration;if(this.countDown=0,this.cacheDurationMs=n?1e3*n:1e3*u.config.globalCacheDuration,this.path=t,!this.path)throw new Error("Invalid path provided for cached path")}return e.prototype.run=function(e){var t=this;if(this.shouldRun(e))return a.queueRenderer.addToQueue(this).pipe((0,r.tap)(function(e){return i.cacheManager.save(t.path,e)}),(0,o.mapTo)(null))},e.prototype.shouldRun=function(e){return this.countDown-=e,this.countDown<=0&&(this.countDown=this.cacheDurationMs,!0)},e.prototype.getUrl=function(){return u.config.domain+this.path},e}();t.CachedPath=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.queueRenderer=t.QueueRenderer=void 0;var r=n(18),o=n(6),i=n(7),u=n(8),a=n(1),c=n(3),s=n(0),f=function(){return(f=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},p=function(){function e(){this.queueSubject=new o.BehaviorSubject([]),this.containerSubjects=this.registerContainers(),this.cachedPathToSubject=new WeakMap,this.subscriptions=new o.Subscription}return e.prototype.addToQueue=function(e){var t=this.cachedPathToSubject.get(e);if(t)return t.asObservable();var n=new o.AsyncSubject;return this.cachedPathToSubject.set(e,n),this.queueSubject.next(this.queueSubject.value.concat([e])),n.asObservable()},e.prototype.registerContainers=function(){var e=this,t=Array.from(Array(s.config.totalBrowsers)).map(function(){return new o.BehaviorSubject({browser$:r.browserManager.openNewInstance().pipe((0,c.shareReplay)(1)),job:null})});t.forEach(function(t){e.registerContainerJobListener(t)});var n=(0,o.combineLatest)([this.queueSubject,(0,o.combineLatest)(t)]).pipe((0,c.debounceTime)(0)).subscribe(function(t){t[1].forEach(function(t,n){return e.tryCreateJob(t,n)})});return this.subscriptions.add(n),t},e.prototype.registerContainerJobListener=function(e){var t=this;this.subscriptions.add(e.pipe((0,c.debounceTime)(0),(0,c.distinctUntilKeyChanged)("job"),(0,u.filter)(function(e){return null!==e.job}),(0,c.flatMap)(function(n){return t.handleJob(n,e)})).subscribe())},e.prototype.tryCreateJob=function(e,t){if(0!==this.queueSubject.value.length&&!e.job){var n=this.queueSubject.value.slice(),r=n.shift();r&&(this.queueSubject.next(n),this.containerSubjects[t].next(f({},e,{job:r})))}},e.prototype.handleJob=function(e,t){var n=this,r=e.job,u=e.browser$;if(!r)throw new Error("Expected job to be defined, in handling of job");return u.pipe((0,c.flatMap)(function(e){return e.activePage$}),(0,c.flatMap)(function(e){return(0,o.combineLatest)([e.open(r.getUrl()),e.awaitPageLoad(),(0,i.of)(e)])}),(0,c.flatMap)(function(e){return e[2].getContent()}),(0,a.tap)(function(e){var o=n.cachedPathToSubject.get(r);if(!o)throw new Error("Unable to retrieve the subject from the cache map");o.next(e),o.complete(),t.next(f({},t.value,{job:null}))}),(0,c.mapTo)(null))},e}();t.QueueRenderer=p;var l=new p;t.queueRenderer=l},function(e,t){e.exports=require("phantom-crawler-server")}]));
//# sourceMappingURL=app.js.map